---
# Direct Pulsar Integration Guide

This document explains how to use the direct Pulsar integration feature for the Delivery Service. The service allows direct pushing of messages to Pulsar topics as an alternative to using the REST API.

---

## Pulsar Topics

The following Pulsar topics are used for different message types:

- **Email**: `delivery-email`
- **SMS**: `delivery-sms`
- **WhatsApp**: `delivery-whatsapp`

---

## Message Structure

### Email Messages

```json
{
  "uuid": "auto-generated-uuid",
  "message": {
    "template": "template-name",
    "to": [
      {
        "name": "Recipient Name",
        "email": "recipient@example.com"
      }
    ],
    "provider": "provider-uuid",
    "refNo": "reference-number",
    "categories": ["category1", "category2"],
    "identifiers": {
      "tenantId": "tenant-id",
      "eventUuid": "event-uuid",
      "actionUuid": "action-uuid",
      "actionCode": "action-code"
    },
    "params": {
      "key1": "value1",
      "key2": "value2"
    },
    "subject": "Email Subject",
    "attachments": [
      {
        "filename": "attachment.pdf",
        "contentType": "application/pdf",
        "content": "base64-encoded-content"
      }
    ]
  }
}
```

### SMS Messages

```json
{
  "uuid": "auto-generated-uuid",
  "message": {
    "to": [
      {
        "telephone": "+1234567890"
      }
    ],
    "from": "Sender",
    "body": "Message body",
    "template": "template-name",
    "provider": "provider-uuid",
    "refNo": "reference-number",
    "categories": ["category1", "category2"],
    "identifiers": {
      "tenantId": "tenant-id",
      "eventUuid": "event-uuid",
      "actionUuid": "action-uuid",
      "actionCode": "action-code"
    },
    "params": {
      "key1": "value1",
      "key2": "value2"
    }
  }
}
```

### WhatsApp Messages

```json
{
  "uuid": "auto-generated-uuid",
  "message": {
    "template": "template-name",
    "to": [
      {
        "name": "Recipient Name",
        "telephone": "+1234567890"
      }
    ],
    "provider": "provider-uuid",
    "refNo": "reference-number",
    "categories": ["category1", "category2"],
    "identifiers": {
        "tenantId": "tenant-id",
        "eventUuid": "event-uuid",
        "actionUuid": "action-uuid",
        "actionCode": "action-code"
      },
    "params": {
      "key1": "value1",
      "key2": "value2"
    },
    "attachments": {
      "inline": [
        {
          "filename": "image.jpg",
          "type": "image/jpeg",
          "content": "base64-encoded-content",
          "contentId": "unique-content-id"
        }
      ]
    }
  }
}
```

## Required Fields

For all message types, the following fields are required:

- `message.template`: The template to use for the message
- `message.to`: At least one recipient
- `message.provider`: The UUID of the provider to use
- `message.refNo`: A unique reference number
- `message.categories`: At least one category
- `message.identifiers.tenantId`: The tenant identifier

Additional requirements by message type:

- **Email**: Recipients must have valid email addresses
- **SMS**: Must include `from` field and recipients must have valid phone numbers in E.164 format
- **WhatsApp**: Recipients must have valid phone numbers in E.164 format

## UUID Generation

The UUID for each message is automatically generated by the system. You don't need to provide it when pushing messages directly to Pulsar.

## Message Tracking

All messages pushed to Pulsar (whether via REST API or direct integration) are recorded in the database with a status of `ACCEPTED`. The UUID returned from the push operation can be used to track the status of the message.

### Auto-Creation of Missing Messages

If a message is received by a consumer but not found in the database, the system will automatically:
1. Create a new message record with status `ACCEPTED`
2. Save the message to the messages table
3. Create an event entry in the message_events table with status `ACCEPTED`
4. Continue processing the message

This ensures resilience in processing messages even when database records might be missing due to failures or out-of-order message receipt.

## Using from Go code

```go
// Example of directly pushing an email message
emailMessage := &models.EmailMessage{
    Template: "welcome_email",
    To: []models.EmailRecipient{
        {
            Name:  "John Doe",
            Email: "john.doe@example.com",
        },
    },
    Provider: "provider-uuid",
    RefNo:    "ref-123",
    Categories: []string{"welcome", "onboarding"},
  Identifiers: map[string]interface{}{
    "tenantId": "tenant-id",
  },
    Subject: "Welcome to Our Service",
}

// Create the email API
db, readerDB, pulsarClient := setupConnections() // Your setup logic here
emailAPI, err := api.NewEmailAPI(db, readerDB, pulsarClient)
if err != nil {
    log.Fatalf("Failed to initialize Email API: %v", err)
}

// Push the message directly
uuid, err := emailAPI.DirectPushEmailMessage(emailMessage)
if err != nil {
    log.Fatalf("Failed to push email message: %v", err)
}

fmt.Printf("Message pushed with UUID: %s\n", uuid)
```

## Using from other languages

To push messages directly from other languages, you can use any Pulsar client library that supports your language. Make sure to format the message according to the schemas above.

For example, using the Python Pulsar client:

```python
import pulsar
import json
import uuid

# Connect to Pulsar
client = pulsar.Client('pulsar://localhost:6650')
producer = client.create_producer('delivery-email')

# Create the message
message = {
    "uuid": str(uuid.uuid4()),
    "message": {
        "template": "welcome_email",
        "to": [
            {
                "name": "John Doe",
                "email": "john.doe@example.com"
            }
        ],
        "provider": "provider-uuid",
        "refNo": "ref-123",
        "categories": ["welcome", "onboarding"],
    "identifiers": {
      "tenantId": "tenant-id"
    },
        "subject": "Welcome to Our Service"
    }
}

# Send the message
producer.send(json.dumps(message).encode('utf-8'))
client.close()
```

Note: When pushing directly to Pulsar from external systems, you are responsible for message validation and proper formatting. The message will not be validated or stored in the database until it's processed by the consumer.
